Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu20.04

%files
    tf-gpu-jk.yml                             /environment.yml
    pystrum              /opt/code/pystrum
    neurite              /opt/code/neurite
    voxelmorph           /opt/code/voxelmorph
    neurite-sandbox      /opt/code/neurite-sandbox
    voxelmorph-sandbox   /opt/code/voxelmorph-sandbox

%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        wget git ca-certificates \
        build-essential \
        cmake \
        pkg-config \
        libfftw3-dev \
        liblapack-dev \
        libblas-dev \
        libgl1 \
        libglib2.0-0 \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh

    export PATH=/opt/conda/bin:$PATH

    # Accept Anaconda TOS
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

    # Create environment
    conda env create -f /environment.yml
    conda clean -a -y

%environment
    export PATH=/opt/conda/bin:$PATH
    source /opt/conda/etc/profile.d/conda.sh
    conda activate tf-gpu-jk

    export PYTHONPATH=/opt/code/pystrum:\
/opt/code/neurite:\
/opt/code/voxelmorph:\
/opt/code/neurite-sandbox:\
/opt/code/voxelmorph-sandbox:$PYTHONPATH

%runscript
    source /opt/conda/etc/profile.d/conda.sh
    conda activate tf-gpu-jk

    export PYTHONPATH=/opt/code/pystrum:\
/opt/code/neurite:\
/opt/code/voxelmorph:\
/opt/code/neurite-sandbox:\
/opt/code/voxelmorph-sandbox:$PYTHONPATH

    exec python "$@"

